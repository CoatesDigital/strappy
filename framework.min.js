$JSKK.Trait.create({$namespace:"framework.trait",$name:"ComponentConnector"})({init:function(a){this._component=a},getParentComponent:function(){return this._component},getCmpName:function(){return this.getParentComponent().my.name},getRadioTower:function(){return this.getParentComponent().radioTower},getStateMgr:function(){return this.getParentComponent().stateMgr},getID:function(){return this.$reflect("namespace")+"."+this.$reflect("name")},getSafeID:function(){return(this.$reflect("namespace")+
"."+this.$reflect("name")).replace(/\./g,"-")},getCmp:function(a){return this.getParentComponent().getCmp(a)},getModel:function(a){return this.getParentComponent().getModel(a)},getView:function(a){return this.getParentComponent().getView(a)},getConfig:function(a){return this.getParentComponent().getConfig(a)}});
$JSKK.Trait.create({$namespace:"framework.trait.signal",$name:"Send"})({sendSignal:function(a,b,c,d){console.debug(this.$reflect("namespace")+"."+this.$reflect("name"),":: sendSignal(trait) :: ",a);if(Object.isEmpty(a))throw Error("Class "+this.$reflect("name")+" attempted to fire an empty signal.");else return this.getRadioTower().fireEvent(a,new framework.Signal({name:a,body:b,type:c,filter:d}))},sendLocalSignal:function(){},sendGlobalSignal:function(){}});
$JSKK.Trait.create({$namespace:"framework.trait.signal",$name:"Receive"})({registerSignals:function(){var a=$JSKK.toArray(arguments);Object.isArray(a)||(a=[a]);for(var b=0,e=a.length;b<e;b++)if(Object.isFunction(this[a[b][1]]))a[b][2]!=framework.Signal.GLOBAL?this.getRadioTower().observe(a[b][0],function(b,c){var d=c.getBody();if(d.id==this.getID()||d.component==this.getCmpName())return this[a[b][1]](c)}.bind(this,b)):this.getRadioTower().observe(a[b][0],this[a[b][1]].bind(this));else throw Error('Attempt to bind signal to undefined callback "'+
a[b][1]+'".');}});
$JSKK.Class.create({$namespace:"framework",$name:"StateMgr",$uses:[framework.trait.signal.Send]})({},{state:{},stateString:"",radioTower:null,eventSupported:false,init:function(){this.radioTower=framework.$radioTower;$(window).bind("hashchange",this.onHashChangeTest.bind(this));this.onHashChange(null,true);var b=window.location.hash;window.location.hash="welcome";(function(){window.location.hash=b;this.bindHashEvent.defer(200,this)}).bind(this).defer(100)},onHashChangeTest:function(){this.eventSupported=
true},bindHashEvent:function(){this.eventSupported?$(window).bind("hashchange",this.onHashChange.bind(this)):this.monitorHashChange()},monitorHashChange:function(){$JSKK.when(function(){return window.location.hash.replace("#","")!=this.stateString}.bind(this)).isTrue(function(){this.onHashChange();this.monitorHashChange()}.bind(this))},onHashChange:function(b,a){console.debug("onHashChange",a?"(supressed)":"");this.stateString=window.location.hash.replace("#","");this.state=Object.isEmpty(this.stateString)?
{}:this.parseStateString(this.stateString);a||this.sendSignal(framework.Signal.STATE_CHANGE,this.state)},registerStateChanger:function(b,a){a=this.parseStateString(a);b.click(this.updateState.bind(this,a))},updateState:function(b){for(var a in b)this.state[a]=b[a];window.location.hash=this.parseStateObject(this.state)},getState:function(){return this.state},parseStateString:function(b){for(var b=b.split("&"),a=null,d={},c=0,e=b.length;c<e;c++){a=b[c].split("=");if(["true","false"].inArray(a[1]))switch(a[1]){case "true":a[1]=
true;break;case "false":a[1]=false}d[a[0]]=a[1]}return d},parseStateObject:function(){var b=[],a;for(a in this.state)b.push(a+"="+this.state[a]);return b.join("&")},getRadioTower:function(){return this.radioTower}});
$JSKK.Class.create({$namespace:"framework",$name:"Signal",$uses:[$JSKK.trait.Configurable]})({LOCAL:"local",GLOBAL:"global",STATE_CHANGE:"state.change",CMP_DO_RECONFIGURE:"component.do.reconfigure",VIEW_IS_READY:"view.is.ready",VIEW_DONE_GOTBASEHTML:"view.done.gotBaseHTML",VIEW_DO_INSERTBASEHTML:"view.do.insertBaseHTML",VIEW_BEFORE_RENDER:"view.before.render",VIEW_DONE_RENDER:"view.done.render",VIEW_DO_SHOW:"view.do.show",VIEW_DO_HIDE:"view.do.hide",VIEW_DONE_SHOW:"view.done.show",VIEW_DONE_HIDE:"view.done.hide",
CONTROLLER_DO_INIT:"controller.do.init",CONTROLLER_DONE_INIT:"controller.done.init",CONTROLLER_DO_DESTROY:"controller.do.destroy",MODEL_DONE_CHANGE:"model.done.change",STATEFULMODEL_DONE_CHANGE:"stateful.model.done.change",STATEFULMODEL_IS_READY:"stateful.model.is.ready",COMMAND_COMPLETE:"command.complete"},{config:{name:null,body:null,type:null,filter:{}},getName:function(){return this.config.name},getBody:function(){return this.config.body},getType:function(){return this.config.type},getFilter:function(){return this.config.filter},
forMe:function(){}});
$JSKK.Class.create({$namespace:"framework.mvc",$name:"Model",$uses:[framework.trait.ComponentConnector,framework.trait.signal.Send]})({},{data:[],proxy:null,getRecord:function(a){return this.data[a]},setRecord:function(a,b){b.id=this.data[0].id;this.data[a]=b;this.sendSignal("view.change",b)},each:function(a){this.data.each(a);return this},add:function(a){this.data.push(a);this.sendSignal(framework.Signal.MODEL_DONE_CHANGE,{name:this.getID()});return this},remove:function(a){for(var b=[],c=0,d=this.data.length;c<
d;c++)this.data[c]!=a&&b.push(this.data[c]);this.data=b;this.sendSignal(framework.Signal.MODEL_DONE_CHANGE,{name:this.getID()});return this}});
$JSKK.Class.create({$namespace:"framework.mvc",$name:"View",$uses:[framework.trait.ComponentConnector,framework.trait.signal.Receive,framework.trait.signal.Send]})({},{_iid:null,_ready:false,_stateBindings:{},contentURL:null,baseHTML:null,element:null,init:function(){this.generateInstanceID();this.registerSignals([framework.Signal.MODEL_DONE_CHANGE,"onModelChange",framework.Signal.GLOBAL],[framework.Signal.STATEFULMODEL_DONE_CHANGE,"onStateChange",framework.Signal.GLOBAL],[framework.Signal.VIEW_DO_INSERTBASEHTML,
"insertBaseHTML"],[framework.Signal.VIEW_DO_SHOW,"onShow"],[framework.Signal.VIEW_DO_HIDE,"onHide"]);this.fetchContent()},fetchContent:function(){$.get(this.$reflect("namespace").replace(/\./g,"/")+"/html/"+this.$reflect("name").toLowerCase()+".html",function(a){this.baseHTML=a;this.sendSignal(framework.Signal.VIEW_DONE_GOTBASEHTML,{component:this.getCmpName(),id:this.getID()})}.bind(this))},insertBaseHTML:function(a){console.debug("insertBaseHTML");var a=a.getBody(),b=$(this.getBaseHTML());b.attr("id",
this.getIID());$(a.where)[a.how](b);this._ready=true;this.onReady();this.sendSignal(framework.Signal.VIEW_IS_READY,{component:this.getCmpName(),id:this.getID()})},getBaseHTML:function(){return this.baseHTML},onReady:$JSKK.emptyFunction,onViewInit:$JSKK.emptyFunction,onModelChange:$JSKK.emptyFunction,generateInstanceID:function(){for(var a="0123456789abcdefghijklmnopqrstuvwxyz".split(""),b=[],c=0;c<8;c++)b.push(a[Math.floor(Math.random()*25)]);this._iid=this.getSafeID()+"-"+b.join("")},getIID:function(){return this._iid},
getContainerClass:function(){return"."+this.getSafeID()},getContainer:function(){return $("#"+this.getIID())},onShow:function(){console.debug("onShow");this.getContainer().fadeIn(500);this.sendSignal(framework.Signal.VIEW_DONE_SHOW,{component:this.getCmpName(),id:this.getID()})},onHide:function(){console.debug("onHide");this.getContainer().fadeOut(500);this.sendSignal(framework.Signal.VIEW_DONE_HIDE,{component:this.getCmpName(),id:this.getID()})},bindStatefulLinks:function(){var a=$JSKK.toArray(arguments);
$JSKK.when(this,"_ready").isTrue(function(){for(var b=null,c=0,d=a.length;c<d;c++)b=$(a[c][0],this.getContainer()),b.length&&this.getStateMgr().registerStateChanger(b,a[c][1])}.bind(this))},bindStateEvents:function(a){for(var b in a)if(Object.isFunction(this[a[b]]))this._stateBindings[b]=this[a[b]].bind(this);else throw Error('Unable to bind state change event for stateful property "'+b+'" because the method "'+a[b]+'" has not been defined on view class "'+this.$reflect("namespace")+"."+this.$reflect("name")+
"");b=0;for(a=a.length;b<a;b++);},onStateChange:function(a){console.debug("onStateChange");var a=a.getBody().change,b;for(b in a)if(Object.isFunction(this._stateBindings[b]))this._stateBindings[b](a[b])}});
$JSKK.Class.create({$namespace:"framework.mvc",$name:"Controller",$uses:[framework.trait.ComponentConnector,framework.trait.signal.Receive,framework.trait.signal.Send]})({},{init:function(){this.registerSignals([framework.Signal.CMP_DO_RECONFIGURE,"onReconfigure"],[framework.Signal.VIEW_IS_READY,"onViewReady"],[framework.Signal.VIEW_DONE_GOTBASEHTML,"onGotBaseHTML"],[framework.Signal.STATEFULMODEL_IS_READY,"onReadyState"])},onReconfigure:$JSKK.emptyFunction,onViewReady:$JSKK.emptyFunction,onGotBaseHTML:$JSKK.emptyFunction,
onReadyState:$JSKK.emptyFunction});
$JSKK.Class.create({$namespace:"framework.mvc.stateful",$name:"Controller",$uses:[framework.trait.ComponentConnector,framework.trait.signal.Receive,framework.trait.signal.Send]})({},{stateModel:null,init:function(){this.registerSignals([framework.Signal.STATE_CHANGE,"_onStateChange",framework.Signal.GLOBAL],[framework.Signal.VIEW_IS_READY,"onViewReady"]);if(!(this.stateModel=this.getModel("State")))throw Error('Unable to initialize "'+this.$reflect("namespace")+"."+this.$reflect("name")+'" State Controller. Controller requires a state model.');
},_onStateChange:function(a){if(this.stateModel.isReady())this.onStateChange(a.getBody())},onStateChange:$JSKK.emptyFunction,onViewReady:$JSKK.emptyFunction,setReady:function(){this.stateModel.setReady(true);return this},updateState:function(a,b){this.stateModel.set(a,b);return this},setViewReadyState:function(a){this.stateModel.setViewReady(a);return this},getReadyViews:function(){return this.stateModel.getReadyViews()}});
$JSKK.Class.create({$namespace:"framework.mvc.stateful",$name:"Model",$uses:[framework.trait.ComponentConnector,framework.trait.signal.Send]})({},{ready:false,readyViews:[],state:{},set:function(a,b){this.state[a]=b;var c={};c[a]=b;this.sendSignal(framework.Signal.STATEFULMODEL_DONE_CHANGE,{component:this.getCmpName(),change:c});return this},setReady:function(a){if(this.ready=a){this.sendSignal(framework.Signal.STATEFULMODEL_IS_READY,{component:this.getCmpName()});var b=this.getStateMgr().getState(),
c;for(c in b)for(var d in this.state)if(d==c){this.state[d]=b[c];break}}this.sendSignal(framework.Signal.STATEFULMODEL_DONE_CHANGE,{component:this.getCmpName(),change:b});return this},isReady:function(){return this.ready},get:function(a){return this.state[a]},setViewReady:function(a){this.readyViews.push(a);return this},getReadyViews:function(){return this.readyViews}});
$JSKK.Class.create({$namespace:"framework",$name:"RadioTower",$uses:[$JSKK.trait.Observable]})({},{events:{}});
$JSKK.Class.create({$namespace:"framework",$name:"Component",$uses:[$JSKK.trait.Configurable]})({},{config:{attachTo:null},browser:{name:null,version:null},components:{},models:[],views:[],controllers:[],_models:{},_views:{},_controllers:{},_configured:false,my:{name:null,index:null,NSObject:null},radioTower:null,stateMgr:null,init:function(){this.my.name=this.$reflect("name");this.my.namespace=this.$reflect("namespace").split(".");if(Object.isUndefined(window.framework.$components))window.framework.$components=
{};Object.isUndefined(window.framework.$components[this.my.name])&&(window.framework.$components[this.my.name]=[]);this.my.index=window.framework.$components[this.my.name].push(this);this.my.NSObject=window;for(var a=0,b=this.my.namespace.length;a<b;a++)this.my.NSObject=this.my.NSObject[this.my.namespace[a]];this.initRadioTower();this.initStateMgr();this.initChildComponents();this.initViews();this.initModels();this.initControllers();Object.isFunction(this.initCmp)&&this.initCmp();this.ready=true;
this.reconfigure()},initRadioTower:function(){if(Object.isUndefined(window.framework.$radioTower))window.framework.$radioTower=new framework.RadioTower;this.radioTower=window.framework.$radioTower},initStateMgr:function(){if(Object.isUndefined(window.framework.$stateMgr))window.framework.$stateMgr=new framework.StateMgr;this.stateMgr=window.framework.$stateMgr},getBrowser:function(){if(Object.isNull(this.browser.name)){if(Object.isDefined(jQuery.browser.msie))this.browser.name="ie";else if(Object.isDefined(jQuery.browser.webkit))this.browser.name=
"webkit";else if(Object.isDefined(jQuery.browser.opera))this.browser.name="opera";else if(Object.isDefined(jQuery.browser.mozilla))this.browser.name="mozilla";this.browser.version=jQuery.browser.version.split(".")[0]}},initChildComponents:function(){var a=null,b=null,c;for(c in this.components){a=this.components[c].split(".");b=window[a[0]];if(Object.isDefined(b))for(var d=1,e=a.length;d<e;d++)if(Object.isDefined(b[a[d]]))b=b[a[d]];else throw Error('Error! component "'+this.components[c]+'" not loaded.');
else throw Error('Error! component "'+this.components[c]+'" not loaded.');this.components[c]=new b}},getCmp:function(a){if(Object.isDefined(this.components[a]))return this.components[a];else throw Error('Unable to get component "'+a+'". This component has not been registered.');},initControllers:function(){for(var a=0,b=this.controllers.length;a<b;a++)if(Object.isDefined(this.my.NSObject[this.my.name.lowerFirst()].controller[this.controllers[a]]))this._controllers[this.controllers[a]]=new (this.my.NSObject[this.my.name.lowerFirst()].controller[this.controllers[a]])(this);
else throw Error('Error controller "'+this.controllers[a]+'" not loaded.');},initViews:function(){for(var a=0,b=this.views.length;a<b;a++)if(Object.isDefined(this.my.NSObject[this.my.name.lowerFirst()])&&Object.isDefined(this.my.NSObject[this.my.name.lowerFirst()].view[this.views[a]]))this._views[this.views[a]]=new (this.my.NSObject[this.my.name.lowerFirst()].view[this.views[a]])(this);else throw Error('Error - view "'+this.views[a]+'" not loaded.');},getView:function(a){if(Object.isDefined(this._views[a]))return this._views[a];
else throw Error('Error - view "'+a+'" has not been initilized.');},initModels:function(){for(var a=0,b=this.models.length;a<b;a++)if(Object.isDefined(this.my.NSObject[this.my.name.lowerFirst()])&&Object.isDefined(this.my.NSObject[this.my.name.lowerFirst()].model[this.models[a]]))this._models[this.models[a]]=new (this.my.NSObject[this.my.name.lowerFirst()].model[this.models[a]])(this);else throw Error('Error - model "'+this.models[a]+'" not loaded for component "'+this.my.name+'".');},getModel:function(a){if(Object.isDefined(this._models[a]))return this._models[a];
else throw Error('Error - model "'+a+'" has not been initilized.');},configure:function(a){$JSKK.when(this,"ready").isTrue(function(){Object.isDefined(this.config)?Object.extend(this.config,a):this.config=a;this._configured=true;this.sendSignal(framework.Signal.CMP_DO_RECONFIGURE,{component:this.my.name})}.bind(this))},reconfigure:function(){$JSKK.when(this,"ready").isTrue(function(){this.sendSignal(framework.Signal.CMP_DO_RECONFIGURE,{component:this.my.name})}.bind(this))},isConfigured:function(){return this._configured},
getConfig:function(a){for(var a=a.split("."),b=this.config,c=0,d=a.length;c<d;c++)if(Object.isDefined(b[a[c]]))b=b[a[c]];else return null;return b},getID:function(){var a=[];Object.extend(a,this.namespace);a.push(this.className);return a.join(".")},sendSignal:function(a,b,c,d){console.debug(this.$reflect("namespace")+"."+this.$reflect("name"),":: sendSignal(core) :: ",a);if(Object.isEmpty(a))throw Error("Class "+this.className+" attempted to fire an empty signal.");else $JSKK.when(this,"radioTower").isAssocArray(function(){this.radioTower.fireEvent(a,
new framework.Signal({name:a,body:b,type:c,filter:d}))}.bind(this))}});
